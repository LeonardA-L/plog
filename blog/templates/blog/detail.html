{% extends "blog/common.html" %}

{% block pagetitle %}
{{article.title}}
{% endblock %}

{% block additional %}

<script type="text/javascript" src="/blog/static/jquery-1.11.2.min.js"></script>

<script type="text/javascript">

function csrfSafeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", "{{csrftoken}}");
        }
    }
});

function addComment(post_id, name, quest, color, message){
    $.ajax({
        url: "/blog/api/comment/",
        type: 'POST',
        data: {
            'csrfmiddlewaretoken':'{{csrf_token}}',
            'post_id':post_id,
            'name':name,
            'quest':quest,
            'color':color,
            'message':message
        },
        dataType:"json",
        success: function( data ) {
            setTimeout(function(){
                // I could probably just reload the part where the comments are
                // Actually that would have been the whole point of using Ajax.
                location.reload();
            }, 200);    // Let's wait for the server to be finished with the transaction. Arbitrary 200ms
        }
    });
};

function submitComment(){
    console.log("adding")
    // well I guess I could check if those are empty or SQL stuff or anything.
    addComment( {{ article.id }}, $("#nameF").val(), $("#questF").val(), "#00DD00", $("#messageF").val());
};

</script>
{% endblock %}

{% block content %}
<div class="a_complete">
    <h1 class="a_title">{{article.title}}</h1>
    <p class="a_sub">Published on {{article.date}}</p>
    <p class="a_cont">{{article.content}}</p>
</div>
<div class="comments_wrap">
    <h2>Comments</h2>
    <div class="comments">
            {% for c in comments %}
                    <h3 class="c_author">{{c.author}}</h3>
                    <p class="c_sub">{{c.quest}}</p>
                    <p class="c_message">{{c.message}}
                    </p>
            {% endfor %}
    </div>
    {% if article.commentable %}
    <h2>Leave a comment</h2>
    <div class="leave_comment">
            <p>
            What is yer name ? <input type="text" name="name" id="nameF" /><br />
            What is yer quest ? <input type="text" name="quest" id="questF" /><br />
            What is ya favorite colour ? <br />
            Message : <br />
            <textarea name="message" id="messageF"></textarea><br />
            <button onclick="submitComment()">Submit</button>
            </p>
            {% else %}
            <p>This post doesn't allow comments (anymore).</p>
    {% endif %}
    </div>
</div>
{% endblock %}
